name: Android Instrumentation Tests (DIY)

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - 'app/src/main/**'
      - 'app/src/androidTest/**'
      - '.github/workflows/instru_test_Custom(DIY).yml'

jobs:
  instrumentation-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # Shared environment for Android SDK + emulator (used mainly in 2.x steps)
    env:
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      ANDROID_AVD_HOME: /home/runner/.android/avd

    steps:
      # ============================================================
      # 1 - GENERAL CI STEPS
      #    (Applies to most Android/Gradle builds)
      #    Diagram: CI Step 1 & CI Step 2
      # ============================================================

      - name: Checkout
        uses: actions/checkout@v4
        # 1.1 GENERAL
        # Diagram: CI Step 1 - Checkout project
        # Pulls source code so Gradle can run (unit tests, instrumentation, etc.)

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
        # 1.2 GENERAL
        # Diagram: CI Step 2 - Set up JDK + Android SDK
        # Provides Java runtime required for any Gradle build.

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        # 1.3 GENERAL
        # Diagram: CI Step 2 - Set up JDK + Android SDK
        # Installs Android tooling used by both unit tests and instrumentation tests.

      # ============================================================
      # 2 - EXCLUSIVE TO INSTRUMENTATION TESTING
      #    2.1 - MANDATORY STEPS
      #    (Needed to run connectedAndroidTest on a custom emulator)
      # ============================================================

      - name: Install emulator and system image
        run: |
          sdkmanager --install "platform-tools" "emulator" "system-images;android-31;google_apis;x86_64"
          sdkmanager --licenses <<< "y"
        # 2.1.1 MANDATORY (ENVIRONMENT)
        # Diagram: CI Step 3 - Choose execution environment
        # Installs the emulator binary + specific Android system image
        # so we can later start a virtual device for instrumentation tests.

      - name: Create AVD
        run: |
          mkdir -p "$ANDROID_AVD_HOME"
          echo "no" | avdmanager create avd -n test -k "system-images;android-31;google_apis;x86_64" -d pixel
          echo "Available AVDs after creation:"
          "$ANDROID_SDK_ROOT/emulator/emulator" -list-avds
        # 2.1.2 MANDATORY (ENVIRONMENT)
        # Diagram: CI Step 3 - Choose execution environment
        # Defines the emulator profile (AVD = "test") that will be used as the
        # device under test for instrumentation.

      - name: Start emulator
        run: |
          EMULATOR="$ANDROID_SDK_ROOT/emulator/emulator"
          echo "Using emulator binary at: $EMULATOR"

          echo "Listing AVDs just before start:"
          "$EMULATOR" -list_avds || "$EMULATOR" -list-avds

          # Start emulator in SOFTWARE mode (no hardware acceleration / KVM) v2.0
          nohup "$EMULATOR" \
            -avd test \
            -no-snapshot \
            -no-window \
            -gpu swiftshader_indirect \
            -no-audio \
            -no-boot-anim \
            -accel off \
            > emulator.log 2>&1 &

          adb wait-for-device

          # Wait for boot completion with timeout (~10 min max)
          booted=""
          attempts=0
          while [ -z "$booted" ] && [ $attempts -lt 60 ]; do
            booted=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')
            echo "Waiting for emulator to boot... attempt $attempts, sys.boot_completed=$booted"
            attempts=$((attempts + 1))
            sleep 10
          done

          if [ "$booted" != "1" ]; then
            echo "Emulator failed to boot in time. Emulator log:"
            cat emulator.log || true
            adb emu kill || true
            exit 1
          fi

          echo "Emulator booted successfully"
          adb shell input keyevent 82
        # 2.1.3 MANDATORY (ENVIRONMENT READY)
        # Diagram: CI Step 3 - Choose execution environment
        # and prepares for Instrumentation Step 3 - Discover device/emulator
        # Boots the emulator and waits until Android is fully started so
        # Gradle can see a ready "device" for instrumentation tests.

      - name: Make gradlew executable
        run: chmod +x gradlew
        # 2.1.4 MANDATORY (BUILD PREP)
        # Diagram: Instrumentation Step 1 - Run Gradle and set up the build
        # Ensures Gradle wrapper can run the instrumentation task.

      - name: Run instrumentation tests
        # 2.1.5 MANDATORY (TEST EXECUTION)
        # Diagram:
        #   - Instrumentation Step 1: Run Gradle and set up the build
        #   - Instrumentation Step 2: Build App and androidTest APKs
        #   - Instrumentation Step 3: Discover device/emulator & install APKs
        #   - Instrumentation Step 4: Launch instrumentation with test runner
        #   - Instrumentation Step 5: Collect results and finish the build
        # Uses a basic retry: if emulator crashes mid-run, we try once more.
        run: |
          ./gradlew connectedAndroidTest || ./gradlew connectedAndroidTest

      # ============================================================
      # 2.2 - OPTIONAL STEPS (INSTRUMENTATION-SPECIFIC)
      #      Can be kept for debugging / visibility, or simplified
      # ============================================================

      - name: Run instrumentation tests (extra run - optional)
        run: ./gradlew connectedAndroidTest
        # 2.2.1 OPTIONAL
        # Diagram: Same as above (Instrumentation Steps 1â€“5)
        # Extra invocation of connectedAndroidTest. This is not strictly
        # required since the previous step already runs tests with a retry.
        # Can be removed in a stable pipeline or kept temporarily for diagnosis.

      - name: Upload AndroidTest HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: androidTest-html-report
          path: app/build/reports/androidTests/connected/**
        # 2.2.2 OPTIONAL (REPORTING)
        # Diagram: Instrumentation Step 5 - Collect results and finish the build
        # Publishes the instrumentation HTML report as a CI artifact. Recommended
        # for visibility, but not required for the tests themselves to run.
